# Blackjack Casino Platform

Полностью сервер-авторитетная игра в блэкджек для Telegram WebApp с платежами, выводами и админ-панелью.

## Ключевые возможности
- Серверная логика на Node.js/Express с детерминированной раздачей карт и защитой от подкручивания со стороны клиента.
- PostgreSQL как единый источник балансовых данных, журналов транзакций и истории раундов.
- Интеграция с Cryptomus (депозиты) и Telegram Stars (депозиты/выводы) с учётом комиссий платформы и провайдера.
- Встроенная панель администратора для мониторинга KPI, управления балансами игроков, настройки комиссий и индивидуальной «подкрутки».
- Клиентская часть для Telegram WebApp с анимациями, звуками, статистикой и синхронным API-мостом.

## Структура репозитория
```
.
├── index.html              # Клиентское мини-приложение
├── js/                     # Логика игры и API-мост
├── css/                    # Стили фронтенда
├── admin/                  # Статическая админ-панель (HTML/CSS/JS)
├── server/                 # Node.js backend + SQL схема
└── netlify.toml            # Базовая конфигурация для статического хостинга
```

## Требования
- Node.js 18 или выше
- PostgreSQL 14 или выше
- Аккаунт Telegram Bot с включенной поддержкой WebApp и Telegram Stars (при необходимости)
- Аккаунт Cryptomus с активированным merchant ID
- Публичный HTTPS-домен для API (Telegram и Cryptomus требуют HTTPS вебхуки)

## Настройка окружения
1. Склонируйте проект и перейдите в папку backend:
    ```powershell
    git clone <repo-url>
    cd blackjack-casino-webapp-main\server
    ```
2. Скопируйте пример окружения и заполните параметры:
    ```powershell
    Copy-Item .env.example .env
    ```
3. Обновите `server/.env`, указав реальные значения. Критичные переменные:

| Переменная | Назначение |
| ----------- | ---------- |
| `DATABASE_URL` | Подключение к PostgreSQL, например `postgresql://user:pass@localhost:5432/blackjack` |
| `JWT_SECRET` | Секрет для подписей токенов и internal-хешей |
| `ADMIN_TELEGRAM_IDS` | Список Telegram ID администраторов (через запятую) |
| `ADMIN_PANEL_SECRET` | Пароль, который вводится в админ-панели вместе с ID |
| `CRYPTOMUS_MERCHANT_ID` / `CRYPTOMUS_API_KEY` | Данные мерчанта Cryptomus |
| `CRYPTOMUS_WEBHOOK_URL` | Публичный HTTPS адрес вебхука `/api/payments/cryptomus/webhook` |
| `TELEGRAM_PROVIDER_TOKEN` | (Опционально) provider token Telegram Stars — нужен только для физических товаров, для цифровых Stars можно оставить пустым |
| `TELEGRAM_BOT_TOKEN` | Bot token, используемый для проверки init data |
| `REQUEST_LIMIT_PER_MINUTE` (опц.) | Ограничение запросов на IP |

## Подготовка базы данных
1. Создайте базу данных в PostgreSQL и пользователя с правами на неё.
2. Примените SQL-схему, чтобы создать таблицы и индексы:
    ```powershell
    psql -d blackjack -f sql/schema.sql
    ```
    Запуск выполняется из директории `server`. Убедитесь, что переменная `DATABASE_URL` указывает на эту базу.

## Запуск backend сервера
1. Установите зависимости и поднимите сервер:
    ```powershell
    cd server
    npm install
    npm run dev
    ```
    По умолчанию сервер слушает порт `5050`. Измените `PORT` в `.env`, если требуется.
2. Проверьте доступность API: `GET http://localhost:5050/health` (эндпоинт создайте самостоятельно при необходимости) или любой из существующих маршрутов.

## Настройка фронтенда
1. В корне репозитория добавьте перед подключением `js/api.js` строку, указывающую адрес backend:
    ```html
    <script>
      window.__API_BASE_URL__ = 'https://your-api-host.com';
    </script>
    ```
    При локальной разработке можно указать `http://localhost:5050`.
2. Запустите статический сервер (любая утилита, например `http-server`):
    ```powershell
    npm install -g http-server
    http-server . -p 4173
    ```
3. Откройте `http://localhost:4173` в браузере Telegram или в окружении WebApp, передавая `initData` через Telegram клиент.

## Интеграция с Telegram
1. Создайте бота через BotFather и включите WebApp кнопки (`/setdomain` и `/setmenubutton`).
2. Укажите URL клиента (например, Netlify URL) как WebApp ссылку.
3. Telegram клиент передаёт `initData` на страницу; скрипт `js/api.js` автоматически проксирует его в заголовке `X-Telegram-Init-Data`.
4. Для локальной отладки используйте туннель (`ngrok http 5050`) и укажите HTTPS адрес туннеля в `window.__API_BASE_URL__` и в настройках бота.

## Интеграция с Cryptomus
1. Создайте merchant в кабинете Cryptomus и получите `merchant_id`, `api_key`.
2. Укажите URL вебхука: `https://<ваш-домен>/api/payments/cryptomus/webhook`.
3. Проверьте, что сервер доступен публично и поддерживает HTTPS; Cryptomus не принимает HTTP.
4. После успешного webhook запроса сервер автоматически начислит средства игроку.

## Telegram Stars (In-App Purchases)
1. Получите provider token у BotFather (`/setpayment`) и добавьте его в `.env`.
2. Эндпоинт `/api/payments/telegram-stars/invoice` генерирует ссылку, возвращаемую клиенту.
3. Комиссии для каждого метода можно настроить через админ-панель в разделе «Комиссии».

## Админ-панель
- Находится в `admin/index.html` и может хоститься как статическая страница на том же домене, что и игра, или отдельно.
- Для входа введите один из `ADMIN_TELEGRAM_IDS` и пароль `ADMIN_PANEL_SECRET`.
- Панель отображает KPI, последние транзакции, позволяет регулировать баланс игроков, управлять заявками на вывод и настраивать house bias.
- Все запросы идут к `/api/admin/*` и требуют защищённого HTTPS соединения.

## Рекомендации по развёртыванию
- Размещайте фронтенд (папка корня и `admin/`) на статическом хостинге (Netlify, Vercel, S3+CloudFront). В файле `netlify.toml` заданы базовые заголовки безопасности.
- Backend запускайте на отдельном сервере (PM2, Docker, Railway). Проверьте CORS и настройте HTTPS (reverse proxy Nginx/Traefik).
- Обновляйте `CRYPTOMUS_WEBHOOK_URL` и адреса в Telegram при каждом изменении домена или туннеля.
- Настройте мониторинг и бэкапы PostgreSQL, чтобы не потерять данные о балансе.

## Дополнительные шаги
- Реализуйте планируемые фоновые антифрод-проверки (velocity, daily win caps) с использованием cron/worker или очереди (Redis, BullMQ).
- Добавьте автотесты и миграции (например, Knex/Prisma) перед выходом в прод.
- Проверьте работу платежей и выводов на тестовых аккаунтах перед запуском для реальных пользователей.

## Лицензия
MIT License. Используйте и модифицируйте проект под свои задачи.